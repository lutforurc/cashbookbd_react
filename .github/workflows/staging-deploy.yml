name: Staging React App CI/CD Pipeline

on:
  push:
    branches:
      - react-staging
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        site:
          [
            cashbookbdaccountsstaging,
            cashbookbdaccountseworld
          ]

    steps:

      # 1) Checkout
      - uses: actions/checkout@v4

      # 2) Setup Node
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      # 3) Install deps
      - run: npm ci

      # 4) Resolve API URL (No Secret - No Masking - Always Works)
      - name: Resolve API URL
        id: api
        run: |
          case "${{ matrix.site }}" in
            cashbookbdaccountsstaging) URL="https://staging.cashbookbd.com" ;;
            cashbookbdaccountseworld) URL="https://eworld.cashbookbd.com" ;;
            *) echo "Unknown site"; exit 1 ;;
          esac

          echo "url=$URL" >> $GITHUB_OUTPUT

      # 5) Build
      - name: Build
        env:
          VITE_SITE_NAME: ${{ matrix.site }}
          VITE_API_URL: ${{ steps.api.outputs.url }}
        run: npm run build -- --mode production

      # 6) Upload artifact
      - uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.site }}
          path: dist

      # 7) Resolve Host
      - name: Resolve host
        id: tgt
        run: echo "host=${{ secrets.REACT_MAIN_HOST }}" >> $GITHUB_OUTPUT

      # 8) Resolve Deploy Path
      - name: Resolve deploy path
        id: path
        run: |
          case "${{ matrix.site }}" in
            cashbookbdaccountsstaging)
              echo "dir=/home/cashbookbdaccountsstaging/htdocs/accounts.staging.cashbookbd.com" ;;
            *) echo "Unknown site"; exit 1 ;;
          esac >> $GITHUB_OUTPUT

      # 9) Setup SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo '${{ secrets.REACT_MAIN_PRIVATE_KEY }}' > ~/.ssh/key
          chmod 600 ~/.ssh/key
          echo -e "Host *\n  IdentityFile ~/.ssh/key\n  StrictHostKeyChecking=accept-new" > ~/.ssh/config

      # 10) Download artifact
      - uses: actions/download-artifact@v4
        with:
          name: dist-${{ matrix.site }}
          path: dist

      # 11) Deploy
      - name: Deploy
        run: |
          rsync -avz --delete \
            -e "ssh -p 22" \
            dist/ \
            "${{ secrets.REACT_MAIN_SSH_USER }}@${{ steps.tgt.outputs.host }}:${{ steps.path.outputs.dir }}/"

      # 12) Reload nginx
      - name: Reload nginx
        run: ssh "${{ secrets.REACT_MAIN_SSH_USER }}@${{ steps.tgt.outputs.host }}" \
               "systemctl reload nginx"

      # 13) Smoke Test
      - name: Smoke Test
        run: curl -I "${{ steps.api.outputs.url }}" | grep -q "200"