name: Staging React-Application CI/CD Pipeline

on:
  push:
    branches: ["staging"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: staging-deploy
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: Build and Deploy React App
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      NODE_ENV: production
      # ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶™‡¶æ‡¶•
      REMOTE_DIR: /home/accounts_staging/htdocs/accounts.staging.cashbookbd.com/

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: |
          set -Eeuo pipefail
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build React app (auto-detect outdir)
        env:
          CI: true
        run: |
          set -Eeuo pipefail
          npm run build
          OUTDIR=""
          if [ -d dist ]; then
            OUTDIR="dist"
          elif [ -d build ]; then
            OUTDIR="build"
          fi
          test -n "$OUTDIR" || (echo "‚ùå No dist/ or build/ found. Check your bundler output." && exit 1)
          echo "OUTDIR=$OUTDIR" >> "$GITHUB_ENV"

      - name: Upload build artifact (for debugging/rollback)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.OUTDIR }}-${{ github.sha }}
          path: ${{ env.OUTDIR }}
          if-no-files-found: error
          retention-days: 7

      - name: Prepare SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_USER: ${{ secrets.USERNAME }}
          SSH_HOST: ${{ secrets.HOST }}
          SSH_PORT: ${{ secrets.PORT }}
          # üëâ ‡¶è‡¶á ‡¶∏‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶ü‡ßá host public key ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶® (e.g. "ssh-ed25519 AAAAC3Nza...")
          SSH_HOST_PUBLIC_KEY_ED25519: ${{ secrets.HOST_PUBLIC_KEY_ED25519 }}
        run: |
          set -Eeuo pipefail
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          cat > ~/.ssh/config <<EOF
          Host staging-host
            HostName $SSH_HOST
            Port ${SSH_PORT:-22}
            UserKnownHostsFile ~/.ssh/known_hosts
            StrictHostKeyChecking yes
          EOF

          if [ -n "${SSH_HOST_PUBLIC_KEY_ED25519:-}" ]; then
            # e.g. "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAI...."
            echo "$SSH_HOST $SSH_HOST_PUBLIC_KEY_ED25519" >> ~/.ssh/known_hosts
          else
            echo "‚ö†Ô∏è Using ssh-keyscan fallback (pin host key for better security)."
            ssh-keyscan -p "${SSH_PORT:-22}" -H "$SSH_HOST" >> ~/.ssh/known_hosts
          fi

      - name: Deploy build via rsync
        env:
          SSH_USER: ${{ secrets.USERNAME }}
          SSH_HOST: ${{ secrets.HOST }}
          SSH_PORT: ${{ secrets.PORT }}
        run: |
          set -Eeuo pipefail
          test -n "${OUTDIR:-}" || (echo "OUTDIR not set" && exit 1)

          echo "üì¶ Local build contents:"
          ls -la "$OUTDIR"/

          # Ensure remote directory exists
          ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" "mkdir -p '$REMOTE_DIR'"

          # Sync with safer delete behavior
          rsync -avz \
            --delete-delay \
            --numeric-ids \
            --chmod=D755,F644 \
            --exclude='.DS_Store' \
            -e "ssh -p ${SSH_PORT:-22}" \
            "$OUTDIR"/ "$SSH_USER@$SSH_HOST:$REMOTE_DIR/"

      - name: (Optional) Fix permissions on server
        continue-on-error: true
        env:
          SSH_USER: ${{ secrets.USERNAME }}
          SSH_HOST: ${{ secrets.HOST }}
          SSH_PORT: ${{ secrets.PORT }}
        run: |
          set -Eeuo pipefail
          ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" "
            sudo chown -R www-data:www-data '$REMOTE_DIR' || true
            find '$REMOTE_DIR' -type d -exec chmod 755 {} \; || true
            find '$REMOTE_DIR' -type f -exec chmod 644 {} \; || true
          "

      - name: Reload web server on VPS
        env:
          SSH_USER: ${{ secrets.USERNAME }}
          SSH_HOST: ${{ secrets.HOST }}
          SSH_PORT: ${{ secrets.PORT }}
        run: |
          set -Eeuo pipefail
          ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" \
            "sudo systemctl reload nginx || sudo systemctl restart nginx"

      - name: Smoke test (HTTP 200/301/302 expected)
        run: |
          set -Eeuo pipefail
          curl -I --max-time 15 https://accounts.staging.cashbookbd.com | tee /tmp/headers.txt
          grep -E '^HTTP/.* (200|301|302) ' /tmp/headers.txt >/dev/null || {
            echo '‚ùå Smoke test failed'; exit 1;
          }