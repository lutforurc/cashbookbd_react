name: Staging React-Application CI/CD Pipeline

on:
  push:
    branches: ["react-staging"]
    tags:
      - "*"
  pull_request:
    branches: ["react-staging"]
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: staging-deploy
  cancel-in-progress: true

jobs:
  sanity-check:
    name: Sanity trigger check
    runs-on: ubuntu-latest
    steps:
      - run: echo "‚úÖ Workflow triggered on $GITHUB_REF ($GITHUB_SHA)"

  build-and-deploy:
    name: Build and Deploy React App
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [sanity-check]
    env:
      NODE_ENV: production
      REMOTE_DIR: ${{ secrets.REACT_STAGING_REMOTE_DIR || '/home/react_staging/htdocs/react.staging.cashbookbd.com/' }}
      DEPLOY_URL: ${{ secrets.REACT_STAGING_DEPLOY_URL || 'https://react.staging.cashbookbd.com' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Clear and verify npm cache
        run: |
          npm cache clean --force
          npm cache verify

      - name: Check Node.js and npm versions
        run: |
          node -v
          npm -v

      - name: Validate configuration and secrets
        run: |
          set -Eeuo pipefail
          # These can come from defaults or secrets
          test -n "${REMOTE_DIR}" || (echo "‚ùå REMOTE_DIR is empty" && exit 1)
          test -n "${DEPLOY_URL}" || (echo "‚ùå DEPLOY_URL is empty" && exit 1)
          # Required secrets
          test -n "${{ secrets.REACT_STAGING_SSH_PRIVATE_KEY }}" || (echo "‚ùå REACT_STAGING_SSH_PRIVATE_KEY is empty" && exit 1)
          test -n "${{ secrets.REACT_STAGING_USERNAME }}" || (echo "‚ùå REACT_STAGING_USERNAME is empty" && exit 1)
          test -n "${{ secrets.REACT_STAGING_HOST }}" || (echo "‚ùå REACT_STAGING_HOST is empty" && exit 1)

      - name: Debug package.json and dependencies
        run: |
          set -Eeuo pipefail
          echo "üìú package.json contents:"
          test -f package.json || (echo "‚ùå package.json not found" && exit 1)
          cat package.json
          echo "üìú Checking for vite in package.json (warn-only):"
          if ! grep -E '"vite":' package.json >/dev/null; then
            echo "‚ö†Ô∏è vite not listed in package.json"
          fi
          echo "üìú Checking for @vitejs/plugin-react (warn-only):"
          grep -E '"@vitejs/plugin-react":' package.json >/dev/null || echo "‚ö†Ô∏è @vitejs/plugin-react not found in package.json"
          echo "üìú package-lock.json exists:"
          ls -la package-lock.json || echo "‚ùå No package-lock.json found"
          echo "üìú node_modules/.bin contents (before install):"
          ls -la node_modules/.bin || echo "No node_modules/.bin directory yet"

      - name: Install dependencies
        run: |
          set -Eeuo pipefail
          echo "üì¶ Installing dependencies with npm install"
          if ! npm install --loglevel verbose --registry https://registry.npmjs.org 2>&1 | tee npm-install.log; then
            echo "‚ùå npm install failed, retrying clean"
            rm -rf node_modules package-lock.json
            if ! npm install --loglevel verbose --registry https://registry.npmjs.org 2>&1 | tee npm-install-retry.log; then
              echo "‚ùå npm install retry failed, installing critical deps"
              npm install --save-dev vite@4.4.7 @vitejs/plugin-react@4.0.0 yaml@2.8.1 --loglevel verbose --registry https://registry.npmjs.org 2>&1 | tee npm-install-critical.log
            fi
          fi
          echo "üìú npm install log:"
          cat npm-install.log || echo "No npm-install.log found"
          [ -f npm-install-retry.log ] && echo "üìú npm install retry log:" && cat npm-install-retry.log
          [ -f npm-install-critical.log ] && echo "üìú npm install critical log:" && cat npm-install-critical.log

      - name: Verify vite and yaml installation
        run: |
          set -Eeuo pipefail
          npx --no vite --version >/dev/null 2>&1 && echo "‚úÖ vite available" || { echo "‚ùå vite not available"; exit 1; }
          node -e "require.resolve('yaml')" && echo "‚úÖ yaml package found" || { echo "‚ùå yaml package not found"; exit 1; }

      - name: Debug installed dependencies
        run: |
          set -Eeuo pipefail
          echo "üìú Installed dependencies:"
          npm list --depth=0 || echo "npm list failed"
          echo "üìú node_modules/.bin contents (after install):"
          ls -la node_modules/.bin

      - name: Build React app (auto-detect outdir)
        env:
          CI: true
        run: |
          set -Eeuo pipefail
          ./node_modules/.bin/vite build
          OUTDIR=""
          if [ -d dist ]; then
            OUTDIR="dist"
          elif [ -d build ]; then
            OUTDIR="build"
          else
            OUTDIR="$(node -e "try{console.log(require('./vite.config.js').build?.outDir||'')}catch{}")"
          fi
          test -n "$OUTDIR" && [ -d "$OUTDIR" ] || (echo "‚ùå No dist/ or build/ found. Check your bundler output." && exit 1)
          echo "OUTDIR=$OUTDIR" >> "$GITHUB_ENV"

      - name: Upload build artifact (for debugging/rollback)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.OUTDIR }}-${{ github.sha }}
          path: ${{ env.OUTDIR }}
          if-no-files-found: error
          retention-days: 7

      - name: Prepare SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.REACT_STAGING_SSH_PRIVATE_KEY }}
          SSH_USER: ${{ secrets.REACT_STAGING_USERNAME }}
          SSH_HOST: ${{ secrets.REACT_STAGING_HOST }}
          SSH_PORT: ${{ secrets.REACT_STAGING_PORT }}
        run: |
          set -Eeuo pipefail
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "‚öôÔ∏è Fetching host key..."
          ssh-keyscan -p "${SSH_PORT:-22}" -H "$SSH_HOST" \
            | sed "s/^$SSH_HOST/[${SSH_HOST}]:${SSH_PORT:-22}/" >> ~/.ssh/known_hosts
          cat > ~/.ssh/config <<EOF
          Host staging-host
            HostName $SSH_HOST
            Port ${SSH_PORT:-22}
            User $SSH_USER
            StrictHostKeyChecking yes
            UserKnownHostsFile ~/.ssh/known_hosts
          EOF

      - name: Debug SSH connection (optional)
        continue-on-error: true
        run: |
          ssh -vvv -p "${{ secrets.REACT_STAGING_PORT }}" "${{ secrets.REACT_STAGING_USERNAME }}@${{ secrets.REACT_STAGING_HOST }}" "echo '‚úÖ Connected:' && whoami && hostname"

      - name: Deploy build via rsync
        env:
          SSH_USER: ${{ secrets.REACT_STAGING_USERNAME }}
          SSH_HOST: ${{ secrets.REACT_STAGING_HOST }}
          SSH_PORT: ${{ secrets.REACT_STAGING_PORT }}
        run: |
          set -Eeuo pipefail
          test -n "${OUTDIR:-}" || (echo "OUTDIR not set" && exit 1)
          echo "üì¶ Local build contents:"
          ls -la "$OUTDIR"/
          ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" "mkdir -p '$REMOTE_DIR'"
          rsync -avz \
            --delete-delay \
            --numeric-ids \
            --chmod=D755,F644 \
            --exclude='.DS_Store' \
            -e "ssh -p ${SSH_PORT:-22}" \
            "$OUTDIR"/ "$SSH_USER@$SSH_HOST:$REMOTE_DIR/"

      - name: Fix permissions on server
        env:
          SSH_USER: ${{ secrets.REACT_STAGING_USERNAME }}
          SSH_HOST: ${{ secrets.REACT_STAGING_HOST }}
          SSH_PORT: ${{ secrets.REACT_STAGING_PORT }}
        run: |
          set -Eeuo pipefail
          ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" "
            sudo chown -R www-data:www-data '$REMOTE_DIR' && \
            find '$REMOTE_DIR' -type d -exec chmod 755 {} \; && \
            find '$REMOTE_DIR' -type f -exec chmod 644 {} \;
          " || { echo "‚ùå Failed to fix permissions"; exit 1; }

      - name: Reload web server on VPS
        env:
          SSH_USER: ${{ secrets.REACT_STAGING_USERNAME }}
          SSH_HOST: ${{ secrets.REACT_STAGING_HOST }}
          SSH_PORT: ${{ secrets.REACT_STAGING_PORT }}
        run: |
          set -Eeuo pipefail
          ssh -p "${SSH_PORT:-22}" "$SSH_USER@$SSH_HOST" \
            "sudo systemctl reload nginx || sudo systemctl restart nginx"

      - name: Smoke test (HTTP 2xx/3xx expected)
        run: |
          set -Eeuo pipefail
          curl -I -L --retry 3 --retry-connrefused --max-time 30 "$DEPLOY_URL" | tee /tmp/headers.txt
          grep -E '^HTTP/.* (200|2..|3..) ' /tmp/headers.txt >/dev/null || {
            echo '‚ùå Smoke test failed'; exit 1;
          }
