name: Production React App CI/CD (kpsnew, no-env)

on:
  push:
    branches: [react-main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build & Deploy â€” kpsnew
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build React app (inject API_URL directly)
        env:
          CI: true
          VITE_SITE_NAME: kpsnew
          VITE_API_URL: ${{ secrets.REACT_MAIN_API_URLS }}
        run: |
          set -Eeuo pipefail
          echo "ğŸ§± Building with SITE_NAME=$VITE_SITE_NAME"
          echo "ğŸ”— Injected API_URL=$VITE_API_URL"
          npm run build -- --mode production

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist-kpsnew-${{ github.sha }}
          path: dist
          if-no-files-found: error
          retention-days: 5

      - name: Resolve deploy target
        id: tgt
        env:
          HOST_RAW: ${{ secrets.REACT_MAIN_HOST }}
          PORT_RAW: ${{ secrets.REACT_MAIN_PORT }}
          SSH_USER: ${{ secrets.REACT_MAIN_SSH_USER }}
        run: |
          set -Eeuo pipefail
          HOST="${HOST_RAW#http://}"
          HOST="${HOST#https://}"
          HOST="${HOST%%/}"
          PORT="${PORT_RAW:-22}"
          echo "host=$HOST" >> "$GITHUB_OUTPUT"
          echo "port=$PORT" >> "$GITHUB_OUTPUT"
          echo "user=$SSH_USER" >> "$GITHUB_OUTPUT"
          echo "ğŸ” Deploy target â†’ $SSH_USER@$HOST:$PORT"

      - name: Prepare SSH (accept new host key automatically)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.REACT_MAIN_PRIVATE_KEY }}
        run: |
          set -Eeuo pipefail
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          {
            echo 'Host *'
            echo '    BatchMode yes'
            echo '    IdentitiesOnly yes'
            echo '    StrictHostKeyChecking=accept-new'
            echo '    UserKnownHostsFile ~/.ssh/known_hosts'
          } >> ~/.ssh/config
          echo "âœ… SSH config ready."

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: dist-kpsnew-${{ github.sha }}
          path: dist

      - name: Deploy via rsync
        env:
          SSH_USER: ${{ steps.tgt.outputs.user }}
          SSH_HOST: ${{ steps.tgt.outputs.host }}
          SSH_PORT: ${{ steps.tgt.outputs.port }}
          REMOTE_DIR: /var/www/html/kpsnew
        run: |
          set -Eeuo pipefail
          : "${SSH_PORT:=22}"
          test -d dist || { echo "âŒ dist not found"; exit 1; }
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "mkdir -p '$REMOTE_DIR'"
          rsync -avz --delete-delay \
            -e "ssh -p ${SSH_PORT}" \
            dist/ "$SSH_USER@$SSH_HOST:$REMOTE_DIR/"
          echo "ğŸš€ Deployed to $REMOTE_DIR"

      - name: Reload nginx
        env:
          SSH_USER: ${{ steps.tgt.outputs.user }}
          SSH_HOST: ${{ steps.tgt.outputs.host }}
          SSH_PORT: ${{ steps.tgt.outputs.port }}
        run: |
          set -Eeuo pipefail
          ssh -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" \
            "sudo -n systemctl reload nginx || sudo -n systemctl restart nginx"
          echo "ğŸ”„ nginx reloaded."

      - name: Smoke test
        env:
          DEPLOY_URL: ${{ secrets.REACT_PROD_DEPLOY_URL }}
        run: |
          set -Eeuo pipefail
          test -n "${DEPLOY_URL-}" || { echo "âŒ REACT_PROD_DEPLOY_URL is empty"; exit 1; }
          curl -I -L --max-time 20 "$DEPLOY_URL" | tee /tmp/headers.txt
          grep -E '^HTTP/.* (200|301|302) ' /tmp/headers.txt >/dev/null || {
            echo 'âŒ Smoke test failed'; exit 1;
          }
