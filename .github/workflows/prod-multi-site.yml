name: React Multi-Site CI/CD

on:
  push:
    branches: [react-main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        site:
          [
            cashbookbdaccountskps,
            cashbookbdaccountsgme,
            cashbookbdaccountskrf,
            cashbookbdaccountsmbdpp,
            cashbookbdaccountsnibirnirman,
            cashbookbdaccountsrmr,
            cashbookbdaccountsscn,
            cashbookbdaccountssinthia
          ]

    steps:

      # 1) Checkout
      - uses: actions/checkout@v4

      # 2) Setup Node
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      # 3) Install deps
      - run: npm ci

      # 4) Resolve API URL (No Secret - No Masking - Always Works)
      - name: Resolve API URL
        id: api
        run: |
          case "${{ matrix.site }}" in
            cashbookbdaccountskps) URL="https://kps.cashbookbd.com" ;;
            cashbookbdaccountsgme) URL="https://gme.cashbookbd.com" ;;
            cashbookbdaccountskrf) URL="https://krf.cashbookbd.com" ;;
            cashbookbdaccountsmbdpp) URL="https://mbdpp.cashbookbd.com" ;;
            cashbookbdaccountsnibirnirman) URL="https://nibirnirman.cashbookbd.com" ;;
            cashbookbdaccountsrmr) URL="https://rmr.cashbookbd.com" ;;
            cashbookbdaccountsscn) URL="https://scn.cashbookbd.com" ;;
            cashbookbdaccountssinthia) URL="https://sinthia.cashbookbd.com" ;;
            cashbookbdaccountsstaging) URL="https://staging.cashbookbd.com" ;;
            *) echo "Unknown site"; exit 1 ;;
          esac

          echo "url=$URL" >> $GITHUB_OUTPUT

      # 5) Build
      - name: Build
        env:
          VITE_SITE_NAME: ${{ matrix.site }}
          VITE_API_URL: ${{ steps.api.outputs.url }}
        run: npm run build -- --mode production

      # 6) Upload artifact
      - uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.site }}
          path: dist

      # 7) Resolve Host
      - name: Resolve host
        id: tgt
        run: echo "host=${{ secrets.REACT_MAIN_HOST }}" >> $GITHUB_OUTPUT

      # 8) Resolve Deploy Path
      - name: Resolve deploy path
        id: path
        run: |
          case "${{ matrix.site }}" in
            cashbookbdaccountskps)
              echo "dir=/home/cashbookbdaccountskps/htdocs/accounts.kps.cashbookbd.com" ;;
            cashbookbdaccountsgme)
              echo "dir=/home/cashbookbdaccountsgme/htdocs/accounts.gme.cashbookbd.com" ;;
            cashbookbdaccountskrf)
              echo "dir=/home/cashbookbdaccountskrf/htdocs/accounts.krf.cashbookbd.com" ;;
            cashbookbdaccountsmbdpp)
              echo "dir=/home/cashbookbdaccountsmbdpp/htdocs/accounts.mbdpp.cashbookbd.com" ;;
            cashbookbdaccountsnibirnirman)
              echo "dir=/home/cashbookbdaccountsnibirnirman/htdocs/accounts.nibirnirman.cashbookbd.com" ;;
            cashbookbdaccountsrmr)
              echo "dir=/home/cashbookbdaccountsrmr/htdocs/accounts.rmr.cashbookbd.com" ;;
            cashbookbdaccountsscn)
              echo "dir=/home/cashbookbdaccountsscn/htdocs/accounts.scn.cashbookbd.com" ;;
            cashbookbdaccountssinthia)
              echo "dir=/home/cashbookbdaccountssinthia/htdocs/accounts.sinthia.cashbookbd.com" ;;
            cashbookbdaccountsstaging)
              echo "dir=/home/cashbookbdaccountsstaging/htdocs/accounts.staging.cashbookbd.com" ;;
            *) echo "Unknown site"; exit 1 ;;
          esac >> $GITHUB_OUTPUT

      # 9) Setup SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo '${{ secrets.REACT_MAIN_PRIVATE_KEY }}' > ~/.ssh/key
          chmod 600 ~/.ssh/key
          echo -e "Host *\n  IdentityFile ~/.ssh/key\n  StrictHostKeyChecking=accept-new" > ~/.ssh/config

      # 10) Download artifact
      - uses: actions/download-artifact@v4
        with:
          name: dist-${{ matrix.site }}
          path: dist

      # 11) Deploy
      - name: Deploy
        run: |
          rsync -avz --delete \
            -e "ssh -p 22" \
            dist/ \
            "${{ secrets.REACT_MAIN_SSH_USER }}@${{ steps.tgt.outputs.host }}:${{ steps.path.outputs.dir }}/"

      # 12) Reload nginx
      - name: Reload nginx
        run: ssh "${{ secrets.REACT_MAIN_SSH_USER }}@${{ steps.tgt.outputs.host }}" \
               "systemctl reload nginx"

      # 13) Smoke Test
      - name: Smoke Test
        run: curl -I "${{ steps.api.outputs.url }}" | grep -q "200"