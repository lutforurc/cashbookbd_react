name: React Multi-Site CI/CD

on:
  push:
    branches: [react-main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        site:
          [
            cashbookbdaccountskps,
            cashbookbdaccountsgme,
            cashbookbdaccountskrf,
            cashbookbdaccountsmbdpp,
            cashbookbdaccountsnibirnirman,
            cashbookbdaccountsrmr,
            cashbookbdaccountsscn,
            cashbookbdaccountssinthia
          ]

    steps:

      # 1) Checkout
      - uses: actions/checkout@v4

      # 2) Node setup
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      # 3) Install dependencies
      - run: npm ci

      # 4) Resolve API URL (MASK-SAFE, ERROR-FREE)
      - name: Resolve API URL
        id: api
        run: |
          RAW="${{ secrets.REACT_MAIN_API_URLS }}"
          KEY="${{ matrix.site }}"

          # Try JSON map â†’ fallback to RAW as single URL
          URL=$(echo "$RAW" | jq -r --arg k "$KEY" \
              'try .[$k] catch empty' 2>/dev/null)

          if [ -z "$URL" ]; then
            URL="$RAW"
          fi

          echo "url=$URL" >> $GITHUB_OUTPUT

      # 5) Build React App
      - name: Build
        env:
          VITE_SITE_NAME: ${{ matrix.site }}
          VITE_API_URL: ${{ steps.api.outputs.url }}
        run: npm run build -- --mode production

      # 6) Upload build artifact
      - uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.site }}
          path: dist

      # 7) Resolve Host
      - name: Resolve host
        id: tgt
        run: echo "host=${{ secrets.REACT_MAIN_HOST }}" >> $GITHUB_OUTPUT

      # 8) Resolve Deploy Path (100% Correct Mapping)
      - name: Resolve deploy path
        id: path
        run: |
          case "${{ matrix.site }}" in
            cashbookbdaccountskps)
              echo "dir=/home/cashbookbdaccountskps/htdocs/accounts.kps.cashbookbd.com" ;;
            cashbookbdaccountsgme)
              echo "dir=/home/cashbookbdaccountsgme/htdocs/accounts.gme.cashbookbd.com" ;;
            cashbookbdaccountskrf)
              echo "dir=/home/cashbookbdaccountskrf/htdocs/accounts.krf.cashbookbd.com" ;;
            cashbookbdaccountsmbdpp)
              echo "dir=/home/cashbookbdaccountsmbdpp/htdocs/accounts.mbdpp.cashbookbd.com" ;;
            cashbookbdaccountsnibirnirman)
              echo "dir=/home/cashbookbdaccountsnibirnirman/htdocs/accounts.nibirnirman.cashbookbd.com" ;;
            cashbookbdaccountsrmr)
              echo "dir=/home/cashbookbdaccountsrmr/htdocs/accounts.rmr.cashbookbd.com" ;;
            cashbookbdaccountsscn)
              echo "dir=/home/cashbookbdaccountsscn/htdocs/accounts.scn.cashbookbd.com" ;;
            cashbookbdaccountssinthia)
              echo "dir=/home/cashbookbdaccountssinthia/htdocs/accounts.sinthia.cashbookbd.com" ;;
            *)
              echo "Unknown site"; exit 1 ;;
          esac >> $GITHUB_OUTPUT

      # 9) SSH Setup
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo '${{ secrets.REACT_MAIN_PRIVATE_KEY }}' > ~/.ssh/key
          chmod 600 ~/.ssh/key
          echo -e "Host *\n IdentityFile ~/.ssh/key\n StrictHostKeyChecking=accept-new" > ~/.ssh/config

      # 10) Download artifact
      - uses: actions/download-artifact@v4
        with:
          name: dist-${{ matrix.site }}
          path: dist

      # 11) Deploy to server
      - name: Deploy
        run: |
          rsync -avz --delete \
            -e "ssh -p 22" \
            dist/ "${{ secrets.REACT_MAIN_SSH_USER }}@${{ steps.tgt.outputs.host }}:${{ steps.path.outputs.dir }}/"

      # 12) Reload nginx
      - name: Reload nginx
        run: ssh "${{ secrets.REACT_MAIN_SSH_USER }}@${{ steps.tgt.outputs.host }}" "systemctl reload nginx"

      # 13) Smoke Test
      - name: Smoke Test
        run: curl -I "${{ steps.api.outputs.url }}" | grep -q "200"
